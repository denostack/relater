import { assertEquals } from "assert/mod.ts";

import { Relater } from "./relater.ts";
import { RelateRule } from "./types.ts";

Deno.test("Relater, decode simple object", () => {
  const relater = new Relater(
    {
      type: "object",
      of: [
        { name: "i8", type: "i8" },
        { name: "u8", type: "u8" },
        { name: "i16", type: "i16" },
        { name: "u16", type: "u16" },
        { name: "i32", type: "i32" },
        { name: "u32", type: "u32" },
        { name: "i64", type: "i64" },
        { name: "u64", type: "u64" },
        { name: "f32", type: "f32" },
        { name: "f64", type: "f64" },
        { name: "string", type: "string", size: 16 },
      ],
    } as const satisfies RelateRule,
  );

  const buffer = new Uint8Array([
    255,
    255,
    255,
    254,
    255,
    254,
    255,
    255,
    255,
    253,
    255,
    255,
    255,
    253,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    252,
    255,
    255,
    255,
    255,
    255,
    255,
    255,
    252,
    64,
    72,
    245,
    195,
    64,
    9,
    33,
    250,
    252,
    139,
    0,
    122,
    104,
    101,
    108,
    108,
    111,
    32,
    119,
    111,
    114,
    108,
    100,
    33,
    0,
    0,
    0,
    0,
  ]);
  const obj = relater.decode(buffer.buffer);
  assertEquals(obj, {
    i8: -1,
    u8: 255,
    i16: -2,
    u16: 65534,
    i32: -3,
    u32: 4294967293,
    i64: -4n,
    u64: 18446744073709551612n,
    f32: 3.140000104904175,
    f64: 3.141592,
    string: "hello world!",
  });
});

Deno.test("Relater, encode simple object", () => {
  const relater = new Relater(
    {
      type: "object",
      of: [
        { name: "i8", type: "i8" },
        { name: "u8", type: "u8" },
        { name: "i16", type: "i16" },
        { name: "u16", type: "u16" },
        { name: "i32", type: "i32" },
        { name: "u32", type: "u32" },
        { name: "i64", type: "i64" },
        { name: "u64", type: "u64" },
        { name: "f32", type: "f32" },
        { name: "f64", type: "f64" },
        { name: "string", type: "string", size: 16 },
      ],
    } as const satisfies RelateRule,
  );

  const encoded = relater.encode({
    i8: -1,
    u8: 255,
    i16: -2,
    u16: 65534,
    i32: -3,
    u32: 4294967293,
    i64: -4n,
    u64: 18446744073709551612n,
    f32: 3.140000104904175,
    f64: 3.141592,
    string: "hello world!",
  });
  assertEquals(
    new Uint8Array(encoded),
    new Uint8Array([
      255,
      255,
      255,
      254,
      255,
      254,
      255,
      255,
      255,
      253,
      255,
      255,
      255,
      253,
      255,
      255,
      255,
      255,
      255,
      255,
      255,
      252,
      255,
      255,
      255,
      255,
      255,
      255,
      255,
      252,
      64,
      72,
      245,
      195,
      64,
      9,
      33,
      250,
      252,
      139,
      0,
      122,
      104,
      101,
      108,
      108,
      111,
      32,
      119,
      111,
      114,
      108,
      100,
      33,
      0,
      0,
      0,
      0,
    ]),
  );
});
